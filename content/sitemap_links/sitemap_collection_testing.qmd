---
title: "Political Sentiment Sitemap Collection Testing"
format: html
---

# Political Sentiment Sitemap Collection Testing

Loading the Libraries required to start work.

```{r}
library(xml2)
library(tidytable)
library(googledrive)
library(googlesheets4)
```

Authorizing `googledrive` to have access to my personal google drive sheet with the data in it. Will remain personal for the time being.

```{r}
# drive_auth()
gs4_auth(token = drive_token())
```

```{r}
# drive_find("political-sentiment")

ss <- drive_get("political-sentiment-sheet")

gathered_sitemaps <- read_sheet(ss)
```

This will be changed as the sitemaps are developed and tested so that it can be used conditionally.

```{r}
#| label: Function Block

sitemap_function_1 <- function(sitemap, 
                               unnest.col = "sitemapindex",
                               filter.col = "loc")
  {
  xml2::read_xml(sitemap) |>
    xml2::as_list() |>
    tibble::as_tibble() |>
    tidyr::unnest_longer(unnest.col) |>
    tidytable::filter(sitemapindex_id == filter.col) |>
    tidyr::unnest(unnest.col) |>
    tidytable::as_tidytable() |>
    tidytable::mutate(sitemapindex = as.character(sitemapindex))
}

sitemap_function_2 <- function(sitemap, 
                               unnest.col = "urlset",
                               filter.col = "loc")
  {
  xml2::read_xml(sitemap) |>
    xml2::as_list() |>
    tibble::as_tibble() |>
    tidyr::unnest_longer(unnest.col) |>
    tidytable::filter(urlset_id == filter.col) |> # Change in XML format
    tidyr::unnest(unnest.col) |>
    tidytable::as_tidytable() |>
    tidytable::mutate(urlset = as.character(urlset))
}

sitemap_function_3 <- function(sitemap, 
                               unnest.col = "urlset",
                               filter.col = "loc")
  {
  xml2::read_xml(sitemap) |>
    xml2::as_list() |>
    tibble::as_tibble() |>
    tidytable::slice(2:n()) |> # Comment in the First Row
    tidyr::unnest_longer(unnest.col) |>
    tidytable::filter(urlset_id == filter.col) |>
    tidyr::unnest(unnest.col) |>
    tidytable::as_tidytable() |>
    tidytable::mutate(urlset = as.character(urlset))
}
```

```{r}
#| label: Sitemap Print
gathered_sitemaps
```

# Sitemap Variable Definitions

```{r}
#| label: Assigning Sitemaps to Variables
heritage_sitemap <- gathered_sitemaps[[1,1]]
cato_sitemap <- gathered_sitemaps[[2,1]]
brookings_sitemap_2022 <- gathered_sitemaps[[3,1]]
aei_sitemap <- gathered_sitemaps[[4,1]]
am_prog_sitemap <- gathered_sitemaps[[5,1]]
cbpp_sitemap <- gathered_sitemaps[[6,1]]
epic_sitemap <- gathered_sitemaps[[7,1]]
hoover_sitemap <- gathered_sitemaps[[8,1]]
claremont_sitemap <- gathered_sitemaps[[9,1]]
mercatus_sitemap <- gathered_sitemaps[[10,1]]
discovery_sitemap <- gathered_sitemaps[[11,1]]
manhattan_sitemap <- gathered_sitemaps[[12,1]]
```

```{r}
#| label: Testing for Sitemap Pull Functions
#| eval: false
heritage_sitemap_links <- read_xml(heritage_sitemap) |> 
  xml2::as_list() |> 
  tibble::as_tibble() |> 
  tidyr::unnest_longer(sitemapindex) |> 
  tidytable::filter(sitemapindex_id == "loc") |> 
  tidyr::unnest(sitemapindex)
  

class(heritage_sitemap_links)
```


```{r}
#| label: First Function Sitemap Acquisition
heritage_sitemap_links <- sitemap_function_1(heritage_sitemap)
cato_sitemap_links <- sitemap_function_1(cato_sitemap)
aei_sitemap_links <- sitemap_function_1(aei_sitemap)
am_prog_sitemap_links <- sitemap_function_1(am_prog_sitemap)
cbpp_sitemap_links <- sitemap_function_1(cbpp_sitemap)
epic_sitemap_links <- sitemap_function_1(epic_sitemap)
mercatus_sitemap_links <- sitemap_function_1(mercatus_sitemap)
manhattan_sitemap_links <- sitemap_function_1(manhattan_sitemap)
```

```{r}
#| label: Second Function Sitemap Acquisition
hoover_sitemap_links <- sitemap_function_2(hoover_sitemap)
```

```{r}
#| label: Third Function Sitemap Acquisition
claremont_sitemap_links <- sitemap_function_3(claremont_sitemap)
discovery_sitemap_links <- sitemap_function_3(discovery_sitemap)
```


# Staging for Sitemap Link Collection

```{r}
heritage_links <- heritage_sitemap_links[[1]]


heritage_all_links <- map(.x = heritage_links, .f = xml2::read_xml)
```

# Unnesting

```{r}
xml_to_tibble <- function(xml) {
  xml |>
    xml2::as_list() |>
    tibble::as_tibble()
}

test <- map_df(.x = heritage_all_links, .f = xml_to_tibble)

test2 <- test |>
  tibble::rowid_to_column() |>
  tidyr::unnest_longer(urlset) |>
  tidytable::filter(urlset_id %in% c("loc","lastmod")) |> # Change in XML format
  tidyr::unnest(cols = urlset) |>
  tidyr::pivot_wider(names_from = urlset_id, values_from = urlset, values_fill = NA) |>
  tidytable::mutate(lastmod = lubridate::ymd_hms(lastmod),
                    loc = as.character(loc)) |>
  tidytable::distinct(loc, .keep_all = TRUE)

class(test2)
```

```{r}

```

