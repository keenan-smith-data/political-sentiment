---
title: "Web Text Test Scraping"
author: "Keenan Smith"
format: html
---

```{r}
#| label: Library Initiation
here::i_am("content/webscrape/web_scraping_testing.qmd")
source(here::here("R", "viable_links.R"))
```


```{r}
detach(package:DBI, unload = TRUE)
library(tidytable)
library(rvest)
```

# Scrape Helper Functions

```{r}
element_pull <- function(e.html, css.tag) {
  e.html |>
    rvest::html_elements(css = css.tag) |>
    rvest::html_text2()
}

text_pull <- function(s.html, text.css = NA) {
  if (is.na(text.css)) {
    s.html |>
      rvest::html_nodes("p") |>
      rvest::html_text2() |>
      tidytable::as_tidytable()
  } else {
    s.html |>
      rvest::html_element(css = text.css) |>
      rvest::html_nodes("p") |>
      rvest::html_text2() |>
      tidytable::as_tidytable()
  }
  
}

date_pull <- function(s.html, date.css) {
  date.text <- element_pull(e.html = s.html, css.tag = date.css)
  date.text <- date.text[1]
  art_date <- lubridate::mdy(date.text)
  return(art_date)
}

author_pull <- function(s.html, author.css, art.source) {
  if (length(author.css) > 1) {
    art.authors <- tidytable::map_chr(.x = author.css, element_pull, e.html = s.html)
    art_author <- paste(art.authors, collapse = ",")
  } else if (length(author.css)  == 1) {
    art.author <- element_pull(s.html, author.css)
    art_author <- paste(art.author, collapse = ", ")
  } else {
    art_author <- art.source
  }
  return(art_author)
}

topic_pull <- function(s.html, topic.css = NA) {
  if (is.na(topic.css)) {
    art_topic <- NA
  } else {
  art.topic <- element_pull(s.html, topic.css)
  if (length(art.topic) > 1) {
    art_topic <- paste(art.topic, collapse = ", ")
  } else if (length(art.topic) == 1) {
    art_topic <- art.topic
  } else {
    art_topic <- NA
  }
  }
  return(art_topic)
}
```

# Main Scraper Function

```{r}
article_pull <- function(hyperlink,
                         title.css.tag,
                         text.css.tag = NA,
                         date.css.tag,
                         author.css.tags,
                         topic.css.tags,
                         art.source) {
  browser()
  source.html <- xml2::read_html(hyperlink)
  art_title <- element_pull(e.html = source.html,
                            css.tag = title.css.tag)
  art_text <- text_pull(s.html = source.html,
                        text.css = text.css.tag)
  art_date <- date_pull(s.html = source.html,
                        date.css = date.css.tag)
  art_author <- author_pull(s.html = source.html,
                            author.css = author.css.tags,
                            art.source = art.source)
  art_topic <- topic_pull(s.html = source.html,
                          topic.css = topic.css.tags)
  final_data <- art_text |>
    tidytable::mutate(
      art_link = hyperlink,
      art_title = art_title,
      art_author = art_author,
      art_date = art_date,
      art_topic = art_topic,
      art_source = art.source
    )
  return(final_data)
  
}
```

```{r}
sample_helper <- function(df) {
  df |>
    slice_sample(n = 10, .by = url_type)
}

#| label: Sample Test Links
aei_sample <- sample_helper(filtered_aei)
am_sample <- sample_helper(filtered_am)
cap_sample <- sample_helper(filtered_cap)
cato_sample <- sample_helper(filtered_cato)
cbpp_sample <- sample_helper(filtered_cbpp)
comf_sample <- sample_helper(filtered_comf)
disc_sample <- sample_helper(filtered_disc)
epi_sample <- sample_helper(filtered_epi)

gutt_sample <- sample_helper(filtered_gutt)
heritage_sample <- sample_helper(filtered_heritage)
hrw_sample <- sample_helper(filtered_hrw)
mani_sample <- sample_helper(filtered_mani)
merc_sample <- sample_helper(filtered_merc)
osf_sample <- sample_helper(filtered_osf)
tnat_sample <- sample_helper(filtered_tnat)
urban_sample <- sample_helper(filtered_urban)


```

```{r}
#| label: Testing Web Scrapes
test_aei_title <- ".entry-title"
test_aei_date <- ".date"
test_aei_tags <- ".tag"
test_aei_author <- ".author-link"
test_aei_text <- ""

article_pull(aei_sample$url[[11]], title.css.tag = test_aei_title,
             date.css.tag = test_aei_date,
             author.css.tags = test_aei_author, topic.css.tags = test_aei_tags,
             art.source = aei_sample$art_source[[1]])


read_html(aei_sample$url[[1]]) |>
  html_nodes("p") |>
  html_text2()
```

<https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop>
Absolute Legend of Help for R ways of doing loops

```{r}
#| label: Testing Iterations

j_data_list <- list()
h_com_data_list <- list()
h_rep_data_list <- list()
b_data_list <- list()

for (i in seq_along(j_test_vec)) {
  j_test_df <- j_pull_try(j_test_vec[i])
  j_test_df$i <- i
  j_data_list[[i]] <- j_test_df
  
  h_com_test_df <- h_com_pull_try(h_com_test_vec[i])
  h_com_test_df$i <- i
  h_com_data_list[[i]] <- h_com_test_df
  
  h_rep_test_df <- h_rep_pull_try(h_rep_test_vec[i])
  h_rep_test_df$i <- i
  h_rep_data_list[[i]] <- h_rep_test_df
  
  b_test_df <- b_pull_try(b_test_vec[i])
  b_test_df$i <- i
  b_data_list[[i]] <- b_test_df
}

j_text_test <- bind_rows(j_data_list)
h_com_text_test <- bind_rows(h_com_data_list)
h_rep_text_test <- bind_rows(h_rep_data_list)
b_text_test <- bind_rows(b_data_list)
```


```{r}
#| label: Testing Webscraping Loops
#| eval: false

j_wrong <- list()
h_com_wrong <- list()
h_rep_wrong <- list()

for (i in seq_along(j_test_wrong)) {
  j_test_df_wrong <- j_pull_try(j_test_wrong[i])
  j_test_df_wrong$i <- i
  j_wrong[[i]] <- j_test_df_wrong
  
  h_com_test_df_wrong <- h_com_pull_try(h_com_test_wrong[i])
  h_com_test_df_wrong$i <- i
  h_com_wrong[[i]] <- h_com_test_df_wrong
  
  h_rep_test_df_wrong <- h_rep_pull_try(h_rep_test_wrong[i])
  h_rep_test_df_wrong$i <- i
  h_rep_wrong[[i]] <- h_rep_test_df_wrong
}

j_text_wrong <- bind_rows(j_wrong)
h_com_text_wrong <- bind_rows(h_com_wrong)
h_rep_text_wrong <- bind_rows(h_rep_wrong)
```

